<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html>
    <head>

        <!-- proper charset -->
        <meta charset="utf-8">
        <!-- Disable mobile scaling -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

        <title>Nicolas Mattia</title>

        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link href="https://fonts.googleapis.com/css?family=Montserrat|Varela+Round" rel="stylesheet">
        <link rel="stylesheet" href="../css/font-awesome/css/font-awesome.min.css">
        <link rel="alternate" type="application/atom+xml" title="nmattia Atom feed" href="../atom.xml?type=blog" />
        <link rel="alternate" type="application/rss+xml" title="nmattia RSS feed" href="../rss.xml?type=blog" />


        <!-- favicon -->
        <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
        <link rel="manifest" href="../site.webmanifest">
        <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#3b6484">
        <meta name="msapplication-TileColor" content="#3b6484">
        <meta name="theme-color" content="#3b6484">



    </head>

    <body>
        <div class="main">
            <div class="header">
                <div class="logo">
                    <a href="../" class="home">Nicolas Mattia</br></a>
                    <div class="links">
                        <a href="https://www.github.com/nmattia"><i class="fa fa-github"></i></a>
                        <a href="https://www.linkedin.com/in/nicolas-mattia/"><i class="fa fa-linkedin"></i></a>
                        <a href="mailto:nicolas@nmattia.com"><i class="fa fa-envelope-o"></i></a>
                    </div>
                </div>
                <div class="nav">
                    <ul>
                        <li><a href="../">home</a></li>
                        <li><a href="../blog.html">blog</a></li>
                        <li><a href="../about.html">about</a></li>
                    </ul>
                </div>
            </div>
            <div class="content">
                <p>I discuss a few reasons why catching bugs in master is more expensive than before they are merged, try to explain why some people think this isn’t true, and talk a bit about merge queues.</p>
<hr />
<style>
.story {
  background-color: lightblue;
  padding: 20px;
  border-radius: 10px;
}

</style>
<h1 id="hunt-bugs-down-before-they-are-merged">Hunt bugs down before they are merged!</h1>
<p>Here’s something I heard a few times from recalcitrant coworkers after I’ve asked them to write more tests in one of my signature uptight PR reviews:</p>
<blockquote>
<p>The cost of fixing a bug <strong>after it has been merged</strong> into the master branch is <strong>the same</strong> as that of fixing it <strong>before it has been merged</strong> into the master branch.</p>
</blockquote>
<p>I beg to differ! Catching a bug once it has landed in the main codebase has a huge associated cost. It boils down to the following reasons, which I’ll describe individually in the next few sections:</p>
<ul>
<li>When someone hits a bug in the main code base, they were most likely not looking for one, but trying to get work done.</li>
<li>Whomever is tasked with fixing the bug may have lost context relevant to the faulty code, or maybe they never had any to start with.</li>
<li>Reporting a bug creates noise in the form of tickets and pull requests (PRs).</li>
</ul>
<p>Let’s jump right in!</p>
<div class="story">
<p>You are a frontend engineer for a company that stores online notes. You’re tasked with writing an autocomplete function allowing the user to find notes more quickly:</p>
<pre><code>
+-----------------------+  +------+
| Gr|                   |  | open |
+-----------------------+  +------+
|                       |
| Great minds.txt       |
|                       |
| Grocery list          |
|                       |
| Grrr! said the lion   |
|                       |
| ...                   |
+-----------------------+
</code></pre>
<p>The following HTTP call returns the list of all of a user’s notes:</p>
<pre class="http"><code>GET /users/&lt;user&gt;/notes?query=&lt;prefix&gt;</code></pre>
</div>
<h3 id="it-gets-in-the-way">It gets in the way</h3>
<div class="story" style="display: inline-block;">
<figure style="float: left;">
<img src="../images/peanut_butter_cookies_nola.jpg" alt="Rated #1 in NOLA">
<figcaption>
And #2 in America!
</figcaption>
</figure>
<p>You’ve been doing amazing work. You got the flow. Mind like water. You’re done with your frontend changes. You spin up a local instance of the server.</p>
<p>You try it out and realize that the server segfaults when there are no matches.</p>
<p>You despair. There goes your flow. The name of the backend engineers flash before your eyes. You consider not inviting them to your wedding. You make a mental list of who’s most likely to have introduced the bug. You consider quitting your job and becoming a barista in a different country – maybe even in New Orleans. You’ll need a specialty, maybe peanut butter cookies. You’ll kill it with your peanut butter cookies. People will know about them from New England to New Mexico. You’ll become famous and, in a few years, run for president of the United States. Then you consider the logistics: your fiancée will need to quit her job, you’ll need to hire a moving service, your dog may not survive the flight.</p>
<p>You stash your local changes and set out to write a test case reproducing the issue.</p>
</div>
<p>Unless you’re a quality analyst, you probably don’t go around trying to find bugs for fun. Most of us discover bugs while trying to get something done: maybe you’re simply using the server, or you’re writing a new feature that depends on a different feature or function. Discovering wrong behavior in a codebase is almost always more of an annoyance than a nice surprise.</p>
<p>Had the bug been caught before merge, the bug reporter would most likely have been the person who introduced the faulty behavior, and would have most likely been expecting to encounter “some” bug (correct software on the first attempt is a myth, sorry).</p>
<h3 id="it-creates-noise">It creates noise</h3>
<div class="story">
<blockquote>
<p>you&gt; <span class="citation" data-cites="channel">@channel</span> I’m experiencing server crashes when there are no matches on <code>/users/foo/notes?query=bar</code>, anybody knows anything about this?</p>
<p>tom&gt; please use <span class="citation" data-cites="here">@here</span> instead of <span class="citation" data-cites="channel">@channel</span></p>
<p>pat&gt; <span class="citation" data-cites="tom">@tom</span> please don’t use “at” channel</p>
<p>jen&gt; <span class="citation" data-cites="you">@you</span> yes I think this is related to #2551</p>
<p>mol&gt; <span class="citation" data-cites="jen">@jen</span> #2551 was fixed last week</p>
<p>jen&gt; okay nevermind, no idea <span class="citation" data-cites="you">@you</span> :(</p>
<p>mkt&gt; <span class="citation" data-cites="channel">@channel</span> lunch?</p>
</blockquote>
</div>
<p>Whether you are reporting issues on Slack, GitHub, JIRA, you name it, reporting a bug creates some noise. Some people will need to label the ticket, will try to help you figure out the cause, others may simply get distracted because of the extra Slack/GitHub/JIRA notifications.</p>
<p>All this can be avoided if bugs are caught before they are merged to master: bugs are typically not reported before the code is part of the mainstream codebase.</p>
<div style="display: inline-block;">
<h3 id="the-hunt">The Hunt</h3>
<figure style="float: right;">
<img src="../images/mads_the_hunt.jpg" alt="Mads “Hunter” Mikkelsen">
<figcaption>
Mads “Hunter” Mikkelsen
</figcaption>
</figure>
<p>This one should be pretty straightforward. Finding a bug that’s been introduced by a diff before merge into the master branch limits the search space to that diff only. Trying to find a bug on master means potentially having to consider the whole codebase, unless your codebase lends itself to things like bisecting.</p>
</div>
<h3 id="lack-of-context">Lack of context</h3>
<div class="story">
<p>The VP of engineering comes to you, in his typical nonchalant tread:</p>
<blockquote>
<p>VP: You’ll need to fix that server crash bug.</p>
<p>You: But!</p>
<p>VP: I know it’s not your area of expertise, but we need this fixed before release.</p>
<p>You: But!</p>
<p>VP: See the bright side: you’ll get to learn some Rust!</p>
<p>You: But… wait what?</p>
<p>VP: Yeah Andy rewrote the backend in rust last week. He’s on holiday now though.</p>
<p>You: …</p>
<p>VP: Good luck! Don’t forget about Engineering breakfast tomorrow.</p>
</blockquote>
<p>As the VP leaves, you sing to yourself:</p>
<blockquote>
<p>… there’s a moooooon over bourbon street …</p>
</blockquote>
</div>
<p>Most of the time no one knows where the bug is and who introduced it. This means that the odds of picking the right engineer to hunt down a bug are about the same as trying to guess who in your team got their tonsils removed last – if anybody actually got their tonsils removed.</p>
<p>The person tasked with fixing the bug then is not particularly likely to know about the part of the codebase that is at fault. Even if the person who introduced the bug is working on hunting it and fixing it, that person might not have worked on that part of the codebase for a while. The context is either absent or has been lost with time, which make debugging longer and more frustrating.</p>
<p>This can be avoided by catching the bugs right after they’ve been written, and before they’ve been merged.</p>
<h3 id="moar-noise">Moar noise</h3>
<div class="story">
<blockquote>
<p>you&gt; <span class="citation" data-cites="channel">@channel</span> I’ve got a fix for the server crash issue, anybody care to review #2578?</p>
<p>tom&gt; please use <span class="citation" data-cites="here">@here</span> instead of <span class="citation" data-cites="channel">@channel</span></p>
<p>pat&gt; <span class="citation" data-cites="tom">@tom</span> please don’t use “at” channel</p>
<p>jen&gt; <span class="citation" data-cites="you">@you</span> yes I’ll have a look in a sec</p>
<p>mol&gt; <span class="citation" data-cites="you">@you</span> sure np</p>
<p>mkt&gt; <span class="citation" data-cites="channel">@channel</span> coffee break?</p>
</blockquote>
</div>
<div style="display: inline-block;">
<figure style="float: left;">
<img src="../images/where_does_it_end.jpg" alt="Where does it end">
<figcaption>
Where does it end?
</figcaption>
</figure>
<p>Fixed the issue? A new round of PRs and reviews creates even more noise. At best this justifies hiring the intern whose job it is to move JIRA tickets around. Most likely it’s a waste of time for everyone involved.</p>
</div>
<h3 id="why-the-fallacy">Why the fallacy?</h3>
<p>So <em>why</em> do some people tend to think that it’s more efficient to merge new code and do damage control later (a.k.a shoot-from-the-hip coding)? Well, in the short term, it may save time for the implementer (let’s call a spade a spade: the culprit) by:</p>
<ul>
<li>Not writing tests or coming up with enough test cases.</li>
<li>Potentially merging without review.</li>
</ul>
<p>These may save time to one person in the short term by allowing them to merge faster and move on to other things; in the greater scheme of things however time and energy is wasted.</p>
<p>Another reason why people tend to believe that fixing a bug in master isn’t necessarily worse than catching it before it is merged is that people often don’t realize that there’s a cost associated with reporting bugs. And this cost grows linearily with the number of people subscribed to the bug tracker, involved in triage, and QA.</p>
<p>If you like your team, please make sure you catch your bugs before others find them themselves!</p>
<h2 id="appendix-merge-queues-for-greater-good">Appendix: merge queues for greater good</h2>
<p>Bugs are not the only way to break master, race conditions also apply to software process. They may happen when a CI system only runs tests on a branch, without rebasing on master first (note: some CI systems, like <a href="https://travis-ci.org/">Travis</a> and <a href="https://circleci.com">CircleCI</a>, will test both your branch as it is <em>and</em> after having rebased it on or merged it into master). The following diagram lists three branches, <code>master</code>, <code>bob</code> and <code>alice</code>:</p>
<div class="story">
<pre><code>
bob master alice
 .    ✓      .   master is green :)
      |
 .    +------+   Alice uses `makeRainbow()`
      |      |
 .    |      ✓   branch alice is green :)
      |      |
 +----+      |   Bob removes `makeRainbow()`
 |    |      |
 ✓    |      |   branch `bob` is green :)
 |    |      |
 +----&gt;      |   branch &quot;bob&quot; is merged
      |      |
      ✓      |   master is green :)
      |      |
      &lt;------+   branch &quot;alice&quot; is merged
      |
      x          master is red :(
      |
      v
</code></pre>
</div>
<p>Alice forks a branch and used the function <code>makeRainbow()</code>. No bug introduced, CI is green, everyone’s happy. Around the same time Bob decides to do some clean up, forks master, and removes the function <code>makeRainbow()</code>. From his point of view, no one is using it, CI is green, everyone’s happy.</p>
<p>Regardless of who merges first – Alice or Bob – the end result can’t be good: Alice’s feature makes use of a function that doesn’t exist in the codebase anymore after Bob’s changes. The solution to avoid those issues is to always rebase a branch before running CI tests:</p>
<div class="story">
<pre><code>
bob master alice
 .    ✓      .   master is green :)
      |
 .    +------+   Alice uses `makeRainbow()`
      |      |
 .    |      ✓   branch &quot;alice&quot; is green :)
      |      |
 +----+      |   Bob removes `makeRainbow()`
 |    |      |
 &lt;----+      |   branch &quot;bob&quot; is rebased on master
 |    |      |
 ✓    |      |   branch &quot;bob&quot; is green and ready for merge :)
 |    |      |
 +----&gt;      |   branch &quot;bob&quot; is merged
      |      |
      |      ?   merge is prevented on branch alice :|
      |      |
      +------&gt;   branch &quot;alice&quot; is rebased on master
      |      |
      |      x   branch &quot;alice&quot; is red :(
      |      |
      |      |   Alice writes a new implementation of `makeRainbow()`
      |      |
      |      ✓   branch &quot;alice&quot; is green and ready for merge :)
      |      |
      &lt;------+   branch &quot;alice&quot; is merged
      |
      ✓          master is green :)
      |
      v
</code></pre>
</div>
<p>The only thing you have to do is to ensure that no branch is merged without being strictly on top of master. The simplest solution is to manually keep track of the branches that should be merged:</p>
<ul>
<li>Whenever someone wants to merge, their branch is enqueued.</li>
<li>Exactly one person pops branches from the queue, rebases them, and merges them if CI is happy.</li>
</ul>
<p>This is a very tedious process and is better automatized by tools like <a href="https://github.com/bors-ng/bors-ng">bors-ng</a>.</p>
<div class="story">

<h3 id="the-poor-mans-merge-queue">The Poor Man’s Merge Queue</h3>
<p>Merge queues need not be fancy. The first time we realized that we were wasting a lot of time fixing rebase issues, my team and I came up with a very simple solution: keep the PR numbers in a Slack channel’s “topic” field. Got a PR you want to merge? Add it to the right of the list. The left-most PR has either been merged or failed CI? Remove it from the list, and rebase the new left-most PR.</p>
<div style="display: inline-block;">
<figure style="float: left;">
<img src="../images/slack-topic-merge-queue.png" alt="Where does it end">
<figcaption>
Save some cost! DIY merge queue.
</figcaption>
</figure>
</div>
            </div>
        </div>

        <script>
          if (document.location.hostname.search("nmattia.com") !== -1) {
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-82921132-1', 'auto');
            ga('send', 'pageview');
            ga('set', 'anonymizeIp', true);
          }
        </script>
    </body>
</html>
