<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html>
    <head>

        <!-- proper charset -->
        <meta charset="utf-8">
        <!-- Disable mobile scaling -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

        <title>Nicolas Mattia</title>

        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link href="https://fonts.googleapis.com/css?family=Montserrat|Varela+Round" rel="stylesheet">
        <link rel="stylesheet" href="../css/font-awesome/css/font-awesome.min.css">
        <link rel="alternate" type="application/atom+xml" title="nmattia Atom feed" href="../atom.xml?type=blog" />
        <link rel="alternate" type="application/rss+xml" title="nmattia RSS feed" href="../rss.xml?type=blog" />


        <!-- favicon -->
        <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
        <link rel="manifest" href="../site.webmanifest">
        <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#3b6484">
        <meta name="msapplication-TileColor" content="#3b6484">
        <meta name="theme-color" content="#3b6484">



    </head>

    <body>
        <div class="main">
            <div class="header">
                <div class="logo">
                    <a href="../" class="home">Nicolas Mattia</br></a>
                    <div class="links">
                        <a href="https://www.github.com/nmattia"><i class="fa fa-github"></i></a>
                        <a href="https://www.linkedin.com/in/nicolas-mattia/"><i class="fa fa-linkedin"></i></a>
                        <a href="mailto:nicolas@nmattia.com"><i class="fa fa-envelope-o"></i></a>
                    </div>
                </div>
                <div class="nav">
                    <ul>
                        <li><a href="../">home</a></li>
                        <li><a href="../blog.html">blog</a></li>
                        <li><a href="../about.html">about</a></li>
                    </ul>
                </div>
            </div>
            <div class="content">
                <p>A few days ago I found myself with two terabytes’ worth of my personal data encrypted but only half of a password. Here are notes from the adventure.</p>
<p>I used the following tools to recover my password:</p>
<ul>
<li><a href="https://gitlab.com/cryptsetup/cryptsetup"><code>cryptsetup</code></a> for dealing with <code>LUKS</code></li>
<li><a href="https://github.com/nmattia/stutter"><code>stutter</code></a> for generating the passwords</li>
<li><a href="https://www.gnu.org/software/parallel/"><code>GNU parallel</code></a> and <code>xargs</code> from <a href="https://www.gnu.org/software/findutils/">findutils</a> for parallelizing the jobs</li>
</ul>
<h2 id="the-story">The story</h2>
<p>Here is basically what happened: I thought it definitely was time for a proper backup of my personal data. I spent some time looking for the right backup tool, found it, freed up two hard drives and formatted them. I said “yes” when the gnome disk utility asked me whether or not I wanted my disks to be encrypted. I picked passphrases, copied my data to the first disk, to the second disk. Happy with the result, I deleted all the data from my laptop, since I had two other replicas. Of course the data was very sensitive (pictures from my childhood, lecture material from university, mind you) so I decided it was <em>waaaaaay</em> too risky to save the passphrases anywhere other than in my very, very reliable memory.</p>
<p>Two weeks later, waiting for the bus, I realized I had no idea what those passphrases were anymore.</p>
<p>One was completely gone. I could not remember at all what it was, how it started or ended, and whether it contained actual words or was just a string of random characters. I remembered some bits of the second one, however. All I would have to do is generate some strings resembling what I remembered and test them against the hard drives.</p>
<h2 id="finding-the-right-tools">Finding the right tools</h2>
<p>I knew the following things about my password that could greatly reduce the search space:</p>
<p><em>note: In order not to disclose my password to the internet, I’ve adapted it a bit. This one might <a href="https://xkcd.com/936/">look familiar</a>. In essence my password was very similar.</em></p>
<ol type="1">
<li>my password contains four words, separated by dashes: <code>&lt;word1&gt;-&lt;word2&gt;-&lt;word3&gt;-&lt;word4&gt;</code></li>
<li><code>&lt;word1&gt;</code> is the word “correct”</li>
<li><code>&lt;word2&gt;</code> is an animal</li>
<li><code>&lt;word3&gt;</code> is either “battery” or “batery”</li>
<li><code>&lt;word4&gt;</code> is either “stable” or “staple”</li>
</ol>
<p>So let’s think for a second. There are three different aspects to this problem:</p>
<ol type="1">
<li>Generate strings based on the fuzzy definition above</li>
<li>Test whether a given string unlocks (any of) the device(s)</li>
<li>Somehow take full advantage of “all” the CPUs I have at my disposal</li>
</ol>
<p>My hard-drives being encrypted with <code>LUKS</code> (we’ll get to what exactly that means in a second) I googled “decrypt <code>LUKS</code>” or something similar, and followed links from there. The project <a href="https://github.com/glv2/bruteforce-luks"><code>bruteforce-luks</code></a> came up, and seemed to be exactly what I needed at first. It parallelizes the jobs and allows you to give hints about what the password looks like. However, it wasn’t flexible enough for my use case, because it only allows you to specify the beginning and/or the end of your password. It does take care of (2) and (3) above, but not (1).</p>
<p>In general I like to abide by the first “rule” of the Unix philosophy:</p>
<blockquote>
<p>Make each program do one thing well.</p>
</blockquote>
<p>Using streams and redirection there’s a lot you can achieve while using simple programs. Moreover, since you get full control over each program (or at least as much as its arguments allow you to) every single solution is still flexible and allows you to iterate quickly. Sometimes you have to get a bit creative but it generally works quite well.</p>
<p>Having a look at our requirements above, what building blocks can we use to solve our problem? Clearly, <a href="https://gitlab.com/cryptsetup/cryptsetup"><code>cryptsetup</code></a> is the perfect tool for (2). For parallelising jobs, <a href="https://www.gnu.org/software/parallel/"><code>GNU parallel</code></a> can also be a great fit, and will do just fine for our use case. Unfortunately I was not able to find the right tool for (1) and had to write my own tool, <a href="https://github.com/nmattia/stutter"><code>stutter</code></a>. There might be such a tool out there but I just couldn’t find it.</p>
<h2 id="generating-the-input">Generating the input</h2>
<p>Let’s see how we can generate the various strings to test as passphrases using <a href="https://github.com/nmattia/stutter"><code>stutter</code></a>. Using <a href="https://github.com/nmattia/stutter"><code>stutter</code></a> is a bit like using <code>grep</code>, but the other way around. You feed <code>grep</code> a bunch of strings and ask whether they match some definition. In comparison you feed <a href="https://github.com/nmattia/stutter"><code>stutter</code></a> a definition and ask to produce the strings that match that definition. Let’s start with a simple example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1">$ <span class="ex">stutter</span> <span class="st">'correct-zebra-batery-stable'</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="ex">correct-zebra-batery-stable</span></a></code></pre></div>
<p>When given a simple string, stutter will simply echo it back to <code>stdout</code>. Now, what did we say? How many <code>t</code>s did we give <code>&lt;word3&gt;</code>? One, two? We’ll let stutter potentially omit the second <code>t</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1">$ <span class="ex">stutter</span> <span class="st">'correct-zebra-bat(t)?ery-stable'</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="ex">correct-zebra-batery-stable</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="ex">correct-zebra-battery-stable</span></a></code></pre></div>
<p>Then, what did we say <code>&lt;word4&gt;</code> was? It couldn’t possibly be “stable”, it must have been “staple”. Though I’m pretty sure something had to do with horses. Let’s keep “stable” around just in case:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1">$ <span class="ex">stutter</span> <span class="st">'correct-zebra-bat(t)?ery-sta(b|p)le'</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="ex">correct-zebra-batery-stable</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="ex">correct-zebra-batery-staple</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="ex">correct-zebra-battery-stable</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="ex">correct-zebra-battery-staple</span></a></code></pre></div>
<p>What else do we know about the passphrase? Right, <code>&lt;word2&gt;</code> is some animal. Let’s first compile a list of animals…</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1">$ <span class="fu">cat</span> animals.txt</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="ex">aardvark</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="ex">albatross</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="ex">alligator</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="ex">alpaca</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="ex">ant</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="ex">anteater</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="ex">antelope</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="ex">ape</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="ex">armadillo</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="ex">ass</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="ex">...</span></a></code></pre></div>
<p>… and tell stutter to use it for generating the strings:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1">$ <span class="ex">stutter</span> <span class="st">'correct-(@animals.txt)-bat(t)?ery-sta(p|b)le'</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="ex">correct-aardvark-batery-staple</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="ex">correct-aardvark-batery-stable</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="ex">correct-aardvark-battery-staple</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="ex">correct-aardvark-battery-stable</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="ex">correct-albatross-batery-staple</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="ex">correct-albatross-batery-stable</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="ex">correct-albatross-battery-staple</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="ex">correct-albatross-battery-stable</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="ex">correct-alligator-batery-staple</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="ex">correct-alligator-batery-stable</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="ex">...</span></a></code></pre></div>
<p>Cool, we solved (1)!</p>
<h2 id="luks-get-cosy">LUK’S get cosy</h2>
<p>Before we start writing hacky shell scripts with <code>sudo</code> sprinkled everywhere, let’s see if we can <em>maybe</em> avoid acting on the hard-drive directly. If we can decouple the jobs from the hard-drive itself, it also means that we can ship our job anywhere (like a <em>big</em> instance somewhere with many, many CPUs) without having to send all of the hard-drive’s content.</p>
<p><code>LUKS</code> seems to be the default way to encrypt a partition on Linux nowadays. It is not a filesystem of its own. Rather, it’s just a <em>specification</em> for partition encryption (<code>LUKS</code> stands for <em>Linux Unified Key Setup</em>). It basically works by specifying a “partition header” (<em>phdr</em>) that should be present on the first bytes of the partition. This partition header declares various things, like how the rest of the partition is encrypted. Below I’ve reproduced a table containing the information about the first 592 bytes of the partition (header) (have a look at the <a href="http://tomb.dyne.org/Luks_on_disk_format.pdf"><code>LUKS</code> specification document</a> for more information):</p>
<table>
<thead>
<tr class="header">
<th style="text-align: right;">start offset</th>
<th>field name</th>
<th style="text-align: right;">length</th>
<th>data type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td>magic</td>
<td style="text-align: right;">6</td>
<td>byte[]</td>
<td>magic for <code>LUKS</code> partition header, see <code>LUKS_MAGIC</code></td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td>version</td>
<td style="text-align: right;">2</td>
<td>uint16_t</td>
<td><code>LUKS</code> version</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8</td>
<td>cipher-name</td>
<td style="text-align: right;">32</td>
<td>char[]</td>
<td>cipher name specification</td>
</tr>
<tr class="even">
<td style="text-align: right;">40</td>
<td>cipher-mode</td>
<td style="text-align: right;">32</td>
<td>char[]</td>
<td>cipher mode specification</td>
</tr>
<tr class="odd">
<td style="text-align: right;">72</td>
<td>hash-spec</td>
<td style="text-align: right;">32</td>
<td>char[]</td>
<td>hash specification</td>
</tr>
<tr class="even">
<td style="text-align: right;">104</td>
<td>payload-offset</td>
<td style="text-align: right;">4</td>
<td>uint32_t</td>
<td>start offset of the bulk data (in sectors)</td>
</tr>
<tr class="odd">
<td style="text-align: right;">108</td>
<td>key-bytes</td>
<td style="text-align: right;">4</td>
<td>uint32 t</td>
<td>number of key bytes</td>
</tr>
<tr class="even">
<td style="text-align: right;">112</td>
<td>mk-digest</td>
<td style="text-align: right;">20</td>
<td>byte[]</td>
<td>master key checksum from PBKDF2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">132</td>
<td>mk-digest-salt</td>
<td style="text-align: right;">32</td>
<td>byte[]</td>
<td>salt parameter for master key PBKDF2</td>
</tr>
<tr class="even">
<td style="text-align: right;">164</td>
<td>mk-digest-iter</td>
<td style="text-align: right;">4</td>
<td>uint32 t</td>
<td>iterations parameter for master key PBKDF2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">168</td>
<td>uuid</td>
<td style="text-align: right;">40</td>
<td>char[]</td>
<td>UUID of the partition</td>
</tr>
<tr class="even">
<td style="text-align: right;">208</td>
<td>key-slot-1</td>
<td style="text-align: right;">48</td>
<td>key slot</td>
<td>key slot 1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">256</td>
<td>key-slot-2</td>
<td style="text-align: right;">48</td>
<td>key slot</td>
<td>key slot 2</td>
</tr>
<tr class="even">
<td style="text-align: right;">…</td>
<td>…</td>
<td style="text-align: right;">…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td style="text-align: right;">544</td>
<td>key-slot-8</td>
<td style="text-align: right;">48</td>
<td>key slot</td>
<td>key slot 8</td>
</tr>
<tr class="even">
<td style="text-align: right;">592</td>
<td>total phdr size</td>
</tr>
</tbody>
</table>
<p>After the partition header, <code>LUKS</code> stores the (encrypted) “key material”, and then the “bulk data”. The “key material” is basically keys used to encrypt the “bulk data”, and the “bulk data” is the actual data that you stored (like those childhood pictures you want to recover). Note that the “key material” itself is encrypted with <em>the</em> pass-phrase, the one you shouldn’t forget. Again: Your passphrase encrypts the <code>LUKS</code> keys, and the <code>LUKS</code> keys encrypt your data. And yes, you can have several <code>LUKS</code> keys, but we won’t care about it too much.</p>
<p>Anyway, the important point is that everything you need in order to check that a given passphrase will allow you to mount your <code>LUKS</code> volume is located at the very beginning of the partition, which we’ll copy locally in order to (once again):</p>
<ol type="1">
<li>avoid the risks associated with tempering with the data directly on the disk</li>
<li>be able to unplug the disk or ship the cracking job somewhere</li>
</ol>
<p>It turns out that <code>cryptsetup</code> won’t work unless it’s got 1,049,600 bytes (or about <span class="math inline">2<sup>20</sup></span> bytes) of data to work with, which is plenty for us, so let’s just copy that (assuming that the actual encrypted partition is <code>/dev/sdb1</code>):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1">$ <span class="fu">dd</span> if=/dev/sdb1 bs=1 count=1049600 of=./encrypted-file</a></code></pre></div>
<p>Let’s see what this looks like:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1">$ <span class="fu">cat</span> encrypted-file <span class="kw">|</span> <span class="fu">head</span> -c 1024</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="ex">LUKS...esxts-plain64sha1...</span></a></code></pre></div>
<p>Ok, doesn’t look like much. If you try the command yourself you’ll most likely see a bunch of funny symbols. Instead of using good old <code>cat</code> we’ll use <code>hexdump</code> which is more appropriate. We’ll use the following <code>hexdump</code> parameters:</p>
<ul>
<li><code>-s &lt;n&gt;</code>: <strong>s</strong>kip, which skips the <code>&lt;n&gt;</code> first bytes</li>
<li><code>-n &lt;n&gt;</code>: which takes <code>&lt;n&gt;</code> bytes only</li>
</ul>
<p>Looking at the table above we see that the first <code>LUKS</code> field is located between the bytes <code>0</code> and <code>6</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1">$ <span class="ex">hd</span> encrypted-file -n 6</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="ex">00000000</span>  4c 55 4b 53 ba be                                 <span class="kw">|</span><span class="ex">LUKS..</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="ex">00000006</span></a></code></pre></div>
<p>This is actually the <code>LUKS_MAGIC</code>, or the things that tells people looking at the partition (like us) that they’re dealing with <code>LUKS</code> (for more information, once again, have a look at the <a href="http://tomb.dyne.org/Luks_on_disk_format.pdf"><code>LUKS</code> specification</a>). Next come the <code>LUKS</code> version (which seems to start at <code>01</code>) and the cipher name:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1">$ <span class="ex">hd</span> encrypted-file -s 6 -n 2</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="ex">00000006</span>  00 01                                             <span class="kw">|</span><span class="ex">..</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="ex">00000008</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">$ <span class="ex">hd</span> encrypted-file -s 8 -n 32</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="ex">00000008</span>  61 65 73 00 00 00 00 00  00 00 00 00 00 00 00 00  <span class="kw">|</span><span class="ex">aes.............</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="ex">00000018</span>  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  <span class="kw">|</span><span class="ex">................</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="ex">00000028</span></a></code></pre></div>
<p>Actually, it shouldn’t come as a surprise that most of what’s stored in the partition header has to do with <em>how</em> your stuff is encrypted:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" data-line-number="1">$ <span class="ex">hd</span> encrypted-file -s 8 -n 96</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="ex">00000008</span>  61 65 73 00 00 00 00 00  00 00 00 00 00 00 00 00  <span class="kw">|</span><span class="ex">aes.............</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="ex">00000018</span>  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  <span class="kw">|</span><span class="ex">................</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="ex">00000028</span>  78 74 73 2d 70 6c 61 69  6e 36 34 00 00 00 00 00  <span class="kw">|</span><span class="ex">xts-plain64.....</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="ex">00000038</span>  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  <span class="kw">|</span><span class="ex">................</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="ex">00000048</span>  73 68 61 31 00 00 00 00  00 00 00 00 00 00 00 00  <span class="kw">|</span><span class="ex">sha1............</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="ex">00000058</span>  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  <span class="kw">|</span><span class="ex">................</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="ex">00000068</span></a></code></pre></div>
<p>We’ll look at one last thing, which is the <code>key-slots</code>. As you can see in the table above, information about the first <code>key-slot</code> can be found at byte <code>208</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" data-line-number="1">$ <span class="ex">hd</span> encrypted-file -s 208 -n 4</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="ex">000000d0</span>  00 ac 71 f3                                       <span class="kw">|</span><span class="ex">..q.</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="ex">000000d4</span></a></code></pre></div>
<p>This is not the key itself (that’d be the “key material” after the partition header). Rather, it’s information about a key. What those four bytes tell us is that the key is <em>active</em>, or <code>ac71fe</code>. If like me you only have one key, the second key (or the last seven keys for that matter) should be marked as <code>dead</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1">$ <span class="ex">hd</span> encrypted-file -s 256 -n 4</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="ex">00000100</span>  00 00 de ad                                       <span class="kw">|</span><span class="ex">....</span><span class="kw">|</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="ex">00000104</span></a></code></pre></div>
<p>Ok, looks like we have what we need. Let’s get started for realz.</p>
<h2 id="the-last-stretch">The last stretch</h2>
<p>We’re almost done, all we need to do is stitch everything together. One thing to note: when testing for a passphrase, <code>cryptsetup</code> returns <code>0</code> if the passphrase unlocks the partition, <code>2</code> if it doesn’t, and something else if there was an unexpected error (like: the partition doesn’t exist). So at the end of the day we just want to know what <code>cryptsetup</code>’s return code is. If it’s <code>2</code>, fine, we provided a bad passphrase, let’s try another one. If it is <em>not</em> <code>2</code>, then we stop and inspect the result (be it the passphrase we were looking for or some error). Here it goes:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="va">crack_maybe=$(</span><span class="fu">cat</span> <span class="op">&lt;&lt;'EOF'</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">    echo PASS | cryptsetup open --test-passphrase ./encrypted-file</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">    rc=$?</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">    if [ &quot;$rc&quot; -ne &quot;2&quot; ]; then</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">    echo &quot;return code $rc on input PASS&quot;</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">    exit 255</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">    fi</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">EOF</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">)</a></code></pre></div>
<p>We’re storing the procedure in some shell variable so that we can pass it to <code>xargs</code>, for instance:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" data-line-number="1">$ <span class="ex">stutter</span> <span class="st">'correct-(@animals.txt)-bat(t)?ery-sta(p|b)le'</span> \</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">    <span class="kw">|</span> <span class="fu">xargs</span> -L 1 -I PASS sh -c <span class="st">'$crack_maybe'</span></a></code></pre></div>
<p>Here’s what happens: <code>stutter</code> feeds potential passphrases to <code>xargs</code>, which calls <code>crack_maybe</code> after having replaced all the occurences of <code>PASS</code> with the potential passphrase. If <code>cryptsetup</code> returns anything else than <code>2</code>, we exit with <code>exit 255</code>, which is basically the only way to tell <code>xargs</code> to stop (otherwise we’d keep going even though we’ve errored out or found the passphrase). Note that this has a hacky feel about it. We’re threading the input in and out of stdout which is not very clean, and it’ll most likely fail on bad input (if your input contains a single-quote character for instance, <code>xargs</code> will complain about it). However it’s enough for my use case.</p>
<p>Not bad, but not parallel either:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" data-line-number="1">$ <span class="ex">stutter</span> <span class="st">'correct-(@animals.txt)-bat(t)?ery-sta(p|b)le'</span> \</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">    <span class="kw">|</span> <span class="ex">parallel</span> --pipe --halt now,fail=1 \</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">    <span class="st">&quot; xargs -n 1 -I PASS sh -c '</span><span class="va">$crack_maybe</span><span class="st">'&quot;</span></a></code></pre></div>
<p>Here it is, the program that’ll hopefully help us find our forgotten passphrase! Here we tell <code>parallel</code> to <code>--pipe</code> the lines to <code>xargs</code> (rather than passing them as an extra argument) and to <code>--halt</code> on the first error, stopping all the processes immediately (because most likely we’ll want to inspect that “error” because it is the passphrase we’re looking for).</p>
<h2 id="the-end">The end</h2>
<p>If you’re interested in reproducing this, I’ve wrapped that in a script (available as a <a href="https://gist.github.com/nmattia/8d3bca0540bf0ffca8c26669051965e4">gist</a> as well):</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co">#!/usr/bin/env bash</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="co"># crack.sh</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="kw">set</span> <span class="ex">-e</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="va">the_pattern=$1</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co"># We need to export because xargs runs in a subshell</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="bu">export</span> <span class="va">the_file=$2</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="kw">if</span><span class="bu"> [</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="va">${the_pattern}</span><span class="st">&quot;</span><span class="bu"> ]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">  <span class="bu">echo</span> pattern missing</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">  <span class="bu">exit</span> 1</a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="kw">fi</span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="kw">if</span><span class="bu"> [</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="va">${the_file}</span><span class="st">&quot;</span><span class="bu"> ]</span>; <span class="kw">then</span></a>
<a class="sourceLine" id="cb16-16" data-line-number="16">  <span class="bu">echo</span> file missing</a>
<a class="sourceLine" id="cb16-17" data-line-number="17">  <span class="bu">exit</span> 1</a>
<a class="sourceLine" id="cb16-18" data-line-number="18"><span class="kw">fi</span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19"></a>
<a class="sourceLine" id="cb16-20" data-line-number="20"><span class="va">crack_maybe=$(</span><span class="fu">cat</span> <span class="op">&lt;&lt;'EOF'</span></a>
<a class="sourceLine" id="cb16-21" data-line-number="21">    echo PASS | cryptsetup open --test-passphrase ${the_file}</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">    rc=$?</a>
<a class="sourceLine" id="cb16-23" data-line-number="23">    if [ &quot;$rc&quot; -ne &quot;2&quot; ]; then</a>
<a class="sourceLine" id="cb16-24" data-line-number="24">    echo &quot;return code $rc on input PASS&quot;</a>
<a class="sourceLine" id="cb16-25" data-line-number="25">    exit 255</a>
<a class="sourceLine" id="cb16-26" data-line-number="26">    fi</a>
<a class="sourceLine" id="cb16-27" data-line-number="27">EOF</a>
<a class="sourceLine" id="cb16-28" data-line-number="28">)</a>
<a class="sourceLine" id="cb16-29" data-line-number="29"></a>
<a class="sourceLine" id="cb16-30" data-line-number="30">echo &quot;starting...&quot;</a>
<a class="sourceLine" id="cb16-31" data-line-number="31">stutter ${the_pattern} \</a>
<a class="sourceLine" id="cb16-32" data-line-number="32">    | parallel --ungroup --block-size 1k --progress --pipe --halt now,fail=1 \</a>
<a class="sourceLine" id="cb16-33" data-line-number="33">    &quot; xargs -n 1 -I PASS sh -c '$crack_maybe'&quot;</a>
<a class="sourceLine" id="cb16-34" data-line-number="34">echo &quot;Done.&quot;</a></code></pre></div>
<p>and a <a href="https://nixos.org/nix/"><code>nix</code></a> file (available as a <a href="https://gist.github.com/nmattia/3752d1b678ca5b54fa68102c17964558">gist</a> as well):</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode nix"><code class="sourceCode bash"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># shell.nix</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">{<span class="ex">anyPkgs</span> ? import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> { }}:</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="bu">let</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">  <span class="ex">pkgs</span> = import (anyPkgs.fetchFromGitHub {</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">      <span class="ex">owner</span> = <span class="st">&quot;NixOS&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">      <span class="ex">repo</span> = <span class="st">&quot;nixpkgs&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">      <span class="fu">rev</span> = <span class="st">&quot;deec3c1dae62e8345451cd8c4ad41134ab95e88d&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8">      <span class="ex">sha256</span> = <span class="st">&quot;1l951xzklxfi2c161mcrps9dfsq76sj8fgq8d60y093bry66d3yc&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9">    }) <span class="dt">{}</span>;</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">  <span class="ex">ghc</span> = pkgs.haskell.compiler.ghc7103<span class="kw">;</span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11">  <span class="co"># tweak haskellSrc2nix to disable (failing) tests</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12">  <span class="ex">haskellSrc2nix</span> = { name, src }:</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">    <span class="ex">pkgs.stdenv.mkDerivation</span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14">      <span class="kw">{</span> <span class="ex">name</span> = <span class="st">&quot;cabal2nix-</span><span class="va">${name}</span><span class="st">&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15">        <span class="ex">buildInputs</span> = [ pkgs.cabal2nix ]<span class="kw">;</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16">        <span class="ex">phases</span> = [<span class="st">&quot;installPhase&quot;</span>]<span class="kw">;</span></a>
<a class="sourceLine" id="cb17-17" data-line-number="17">        <span class="ex">LANG</span> = <span class="st">&quot;en_US.UTF-8&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-18" data-line-number="18">        <span class="ex">LOCALE_ARCHIVE</span> = pkgs.lib.optionalString pkgs.stdenv.isLinux <span class="st">&quot;</span><span class="va">${pkgs</span><span class="er">.glibcLocales</span><span class="va">}</span><span class="st">/lib/locale/locale-archive&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-19" data-line-number="19">        <span class="ex">installPhase</span> = <span class="st">''</span></a>
<a class="sourceLine" id="cb17-20" data-line-number="20">          <span class="bu">export</span> <span class="va">HOME=</span><span class="st">&quot;</span><span class="va">$TMP</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb17-21" data-line-number="21">          <span class="fu">mkdir</span> -p <span class="st">&quot;</span><span class="va">$out</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb17-22" data-line-number="22">          <span class="ex">cabal2nix</span> --no-check --compiler=<span class="va">${ghc</span><span class="er">.name</span><span class="va">}</span> --system=<span class="va">${pkgs</span><span class="er">.stdenv.system</span><span class="va">}</span> <span class="st">&quot;</span><span class="va">${src}</span><span class="st">&quot;</span> <span class="op">&gt;</span> <span class="st">&quot;</span><span class="va">$out</span><span class="st">/default.nix&quot;</span></a>
<a class="sourceLine" id="cb17-23" data-line-number="23">        <span class="st">''</span>;</a>
<a class="sourceLine" id="cb17-24" data-line-number="24">      <span class="kw">}</span>;</a>
<a class="sourceLine" id="cb17-25" data-line-number="25">  <span class="ex">callCabal2nixNoCheck</span> = name: src: pkgs.haskellPackages.callPackage (haskellSrc2nix { inherit src name<span class="kw">;</span> });</a>
<a class="sourceLine" id="cb17-26" data-line-number="26">  <span class="ex">snipcheck</span> = callCabal2nixNoCheck <span class="st">&quot;snipcheck&quot;</span></a>
<a class="sourceLine" id="cb17-27" data-line-number="27">    <span class="kw">(</span> <span class="ex">pkgs.fetchFromGitHub</span></a>
<a class="sourceLine" id="cb17-28" data-line-number="28">        <span class="kw">{</span>  <span class="ex">owner</span>  = <span class="st">&quot;nmattia&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-29" data-line-number="29">           <span class="ex">repo</span>   = <span class="st">&quot;snipcheck&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-30" data-line-number="30">           <span class="fu">rev</span>    = <span class="st">&quot;ed2d586986fab3d781a388c314d18b01527b2d51&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-31" data-line-number="31">           <span class="ex">sha256</span> = <span class="st">&quot;15hsgv9wz3l6q9533azf62ly5y5cscsi18w2nm5bfzh6pilzfdrb&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-32" data-line-number="32">        <span class="kw">}</span></a>
<a class="sourceLine" id="cb17-33" data-line-number="33">    <span class="kw">)</span> <span class="kw">{</span> <span class="kw">}</span>;</a>
<a class="sourceLine" id="cb17-34" data-line-number="34">  <span class="ex">stutter</span> = callCabal2nixNoCheck <span class="st">&quot;stutter&quot;</span></a>
<a class="sourceLine" id="cb17-35" data-line-number="35">    <span class="kw">(</span> <span class="ex">pkgs.fetchFromGitHub</span></a>
<a class="sourceLine" id="cb17-36" data-line-number="36">        <span class="kw">{</span> <span class="ex">owner</span>  = <span class="st">&quot;nmattia&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-37" data-line-number="37">          <span class="ex">repo</span>   = <span class="st">&quot;stutter&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-38" data-line-number="38">          <span class="fu">rev</span>    = <span class="st">&quot;bf280eee30939a0699b0ee077fc38a738509d4e6&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-39" data-line-number="39">          <span class="ex">sha256</span> = <span class="st">&quot;0mg38xqd7b2j5zh7hyjzlyw7mc0bbsp7yf6jypml8ha53p321m6s&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb17-40" data-line-number="40">        <span class="kw">}</span></a>
<a class="sourceLine" id="cb17-41" data-line-number="41">    <span class="kw">)</span> <span class="kw">{</span> <span class="ex">inherit</span> snipcheck<span class="kw">;</span> <span class="kw">}</span> ;</a>
<a class="sourceLine" id="cb17-42" data-line-number="42"><span class="kw">in</span></a>
<a class="sourceLine" id="cb17-43" data-line-number="43"><span class="ex">pkgs.stdenv.mkDerivation</span> {</a>
<a class="sourceLine" id="cb17-44" data-line-number="44">  <span class="va">name=</span><span class="st">&quot;hello&quot;</span>;</a>
<a class="sourceLine" id="cb17-45" data-line-number="45">  <span class="ex">buildInputs</span> = [ stutter pkgs.cryptsetup pkgs.parallel ]<span class="kw">;</span></a>
<a class="sourceLine" id="cb17-46" data-line-number="46">}</a></code></pre></div>
<p>This way, if you have <code>nix</code> installed you can call <code>nix-shell</code> and run</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" data-line-number="1">$ <span class="ex">./crack.sh</span> <span class="op">&lt;</span>some-pattern<span class="op">&gt;</span> <span class="op">&lt;</span>some-partition<span class="op">&gt;</span></a></code></pre></div>
<p>and your computer will use as many cores at it can to crack the <code>LUKS</code> passphrase of <code>&lt;some-partition&gt;</code> using <code>&lt;some-pattern&gt;</code>. Even better, you could rent a big AWS machine for a few hours and ship the job there:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="fu">rsync</span> ~/local/crack/shell.nix user@remote:/home/crack/</a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="fu">rsync</span> ~/local/crack/crack.sh user@remote:/home/crack/</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="fu">rsync</span> ~/local/crack/encrypted-file user@remote:/home/crack/</a></code></pre></div>
<p>This is basically what I did when I started writing this blog post this morning. First, I hoped that the script would actually test all the passphrases and that I didn’t miss some weird corner case that would make it skip <em>the</em> correct passphrase, or would make it fail to report a correct passphrase. Second, I also hoped that I did actually remember correctly those bits of the passphrase. My input was a bit bigger than the one presented here. My equivalent of <code>animals.txt</code> was <code>/usr/share/dict/american-english</code> which contains about 60k words. The words were tested alphabetically, and throughout the day I kept tabs on the progress. Around noon the script had already covered all the words starting with a capital letter. Around 4pm it was past the letter <code>n</code>, and at 10pm it had reached the letter <code>w</code>, still no match. Well, it turns out the missing word was <code>witch</code>, which is in the last 2 percent of the Ubuntu dictionary of English words! Still not sure how I came up with that, and also I’m glad I didn’t give up when I reached the letter <code>v</code> as I almost did (because how likely is it that it’ll be in the last 5%, right?).</p>
<p>I surely learned a fair bit about <code>LUKS</code> and <code>GNU parallel</code> in the process, and hope you learned something too. Don’t hesitate to share your thoughts on this and please let me know if you spot something that’s not correct. Now I’ve got to go, it’s time for me to go look at childhood pictures (and pick a new passphrase).</p>
            </div>
        </div>

        <script>
          if (document.location.hostname.search("nmattia.com") !== -1) {
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-82921132-1', 'auto');
            ga('send', 'pageview');
          }
        </script>
    </body>
</html>
